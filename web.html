<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>a web page</title>
    <script language="javascript" type="text/javascript" src="My97DatePicker/WdatePicker.js"></script>
    <script language="javascript" type="text/javascript" src="jquery-1.7.2.min.js"></script>
    <script language="javascript" type="text/javascript" src="echarts.js"></script>
    
  </head>
  <body>
    <p>数据表1：</p>
    <input type="checkbox">发布职位数
    <input type="checkbox">发布简历数
    <input type="checkbox">推荐数
    <input type="checkbox">面试数
    <input type="checkbox">offer数
    <input type="checkbox">入职数
    <br />
    <p>数据表2：</p>
    <input type="checkbox">公司留存率
    <input type="checkbox">活跃公司数
    <input type="checkbox">用户留存率
    <input type="checkbox">活跃用户数
    <input type="checkbox">推荐率
    <input type="checkbox">人才复用率
    <input type="checkbox">推offer率
    <br />
    <br />
    <br />
    <br />
    <span>起始时间：</span><input type="text" onClick="WdatePicker()" id="startTime" />
    <span>结束时间：</span><input type="text" onClick="WdatePicker()" id="endTime" />    
    <span>猎头公司：</span>
    <select id="select">
        <option value="">全部公司</option>
        <option value="91">协骏咨询</option>
        <option value="92">索乐咨询</option>
        <option value="117">塔森猎头</option>
        <option value="118">瑞方人力</option>
        <option value="126">捷毅人力</option>
        <option value="131">长沙协骏</option>
        <option value="132">基业百年</option>
        <option value="133">策德咨询</option>
        <option value="134">莫仕咨询</option>
        <option value="142">铜雀咨询</option>
        <option value="147">锐智人才</option>
        <option value="155">协骏-互联网</option>
        <option value="157">上海猎睿</option>
        <option value="159">陶菊红</option>
        <option value="160">坤如玛丽</option>
        <option value="162">用睿咨询</option>
        <option value="164">sr</option>
        <option value="165">上海启众</option>
        <option value="166">何东金融</option>
        <option value="167">connected-in</option>
        <option value="168">古大集团</option>
        <option value="171">才集猎头</option>
        <option value="172">佰思益</option>
        <option value="180">MG</option>
        <option value="182">王叶扣</option>
        <option value="183">argos</option>
        <option value="184">博唐咨询</option>
        <option value="185">环迅支付</option>
        <option value="186">优途咨询</option>
        <option value="187">李秀麟</option>
        <option value="188">黄宇鹏</option>
        <option value="189">卡碧恩</option>
        <option value="191">璞若</option>
        <option value="193">朱梦佳</option>
        <option value="194">引顺咨询</option>
        <option value="195">优聘信息</option>
        <option value="196">智邦</option>
        <option value="197">李昱成</option>
        <option value="198">大拿金融</option>
        <option value="199">陈芳芳</option>
        <option value="200">常慧婧</option>
        <option value="201">tracy</option>
        <option value="202">傲福</option>
        <option value="203">曼格</option>
        <option value="208">艺创</option>
        <option value="214">伊捷</option>
        <option value="217">怡瑞</option>
        <option value="218">鼎骏咨询</option>
        <option value="222">上海英擎</option>
        <option value="223">上海乐宣</option>
        <option value="224">嘉乐道</option>
        <option value="225">华翰咨询</option>
        <option value="227">名猎</option>
        <option value="231">英沛咨询</option>
        <option value="234">葵柯咨询</option>
        <option value="236">沃瑞咨询</option>
        <option value="238">衡驰</option>
        <option value="241">励邻</option>
        <option value="244">鸿迅咨询</option>
        <option value="248">上海耕乐</option>
        <option value="249">西安博泰</option>
        <option value="250">领程</option>
        <option value="251">贝拉特</option>
        <option value="253">瑞思</option>
        <option value="254">合众合</option>
        <option value="255">慧语咨询</option>
        <option value="256">中品盛仕</option>
        <option value="257">泰一咨询</option>
        <option value="258">斯泰普</option>
        <option value="259">环球希望</option>
        <option value="260">纳之杰</option>
        <option value="261">易联人和</option>
        <option value="262">瑞智德美</option>
        <option value="263">盛亦</option>
        <option value="264">南京辅佐</option>
        <option value="265">瑞诺</option>
        <option value="266">卡碧恩</option>
        <option value="269">Ur Career</option>
        <option value="270">极客猎头</option>
        <option value="273">德仕英才</option>
        <option value="278">伯乐易才</option>
        <option value="279">凌卓咨询</option>
        <option value="285">睿泉咨询</option>
        <option value="286">伯世英才</option>
        <option value="287">欧悉哲</option>
        <option value="288">普瑞斯</option>
        <option value="289">钧瑶</option>
        <option value="290">善索咨询</option>
        <option value="291">优仕一方</option>
        <option value="292">脉睿科技</option>
        <option value="293">外企德科</option>
        <option value="300">蒙塔咨询</option>
        <option value="301">德安思普</option>
        <option value="303">聿轩</option>
        <option value="306">途骥</option>
        <option value="309">聂智玉</option>
        <option value="310">安飞</option>
        <option value="316">赛与阳</option>
        <option value="319">凌力咨询</option>
        <option value="321">瞬沃</option>
        <option value="326">环亚</option>
        <option value="328">李湘怡</option>
        <option value="339">知钦咨询</option>
        <option value="348">李红</option>
        <option value="354">卡德威诚</option>
        <option value="355">全本</option>
        <option value="360">骏蕤</option>
        <option value="361">越泽</option>
        <option value="362">义永商务</option>
        <option value="363">朱洁琼</option>
        <option value="364">众云</option>
        <option value="383">梅一咨询</option>
        <option value="386">forever</option>
        <option value="392">汤凌玮</option>
    </select>
    <input type="checkbox" id='reverseSelection'>去除该公司
    <button onclick="makeChart()">生成图表</button> 
    <div id="charts" style="height:400px;width:650px;float:left">

    </div>
    <div id="charts2" style="height:400px;width:650px;float:left">

    </div>
    <div id="charts3" style="height:400px;width:650px;float:left">

    </div>
  </body>
  <script type="text/javascript">

    var selectedOptionList = [];

    var firstChartLegend = [];

    var positionCountData = [];
    var resumeCountData = [];
    var interviewCountData = [];
    var offerCountData = [];
    var jobCountData = [];  //入职数
    var entrustCountData = [];  //推荐数

    var entrustRateData = [];
    var interviewRateData = [];
    var offerRateData = [];
    var stayRateData = [];
    var companyStayRateData = [];

    var companyStayNumData = [];
    var stayNumData = [];

    function chooseDataToDisplay(){
        selectedOptionList = [];
        var counter = 0;
        $("input[type=checkbox]").each(function(){
            if ($(this).attr("checked")=="checked"){
                selectedOptionList.push(counter);
            }; 
            counter++;
        });
    }

    function inArray(valueToSearch, arrayToSearch){
        for (s = 0; s < arrayToSearch.length; s++) {
            thisEntry = arrayToSearch[s].toString();
            if (thisEntry == valueToSearch) {
               return true;
            }
        }
        return false;
    }

    function timestampToDate(timestamp1){
        var time = new Date(timestamp1*1000);
        var y = time.getFullYear();
        var m = time.getMonth()+1;
        var d = time.getDate();
        return y+ '-' + m + '-' + d;
    }

    function datetime_to_unix(datetime){
        var tmp_datetime = datetime.replace(/:/g,'-');
        tmp_datetime = tmp_datetime.replace(/ /g,'-');
        var arr = tmp_datetime.split("-");
        var now = new Date(Date.UTC(arr[0],arr[1]-1,arr[2]));
        return parseInt(now.getTime()/1000);
    }

    function getCountSeries(){
        var countSeries = [];
        chooseDataToDisplay();  //获取勾选了的项
        firstChartLegend = [];
        if (inArray(0,selectedOptionList)){
            countSeries.push({
                name:'新增职位数',
                type:'line',
                smooth:true,
                symbol: 'none',
                sampling: 'average',
                data: positionCountData
            });
            firstChartLegend.push("新增职位数");
        }
        if (inArray(1,selectedOptionList)){
            countSeries.push({
                name:'新增简历数',
                type:'line',
                smooth:true,
                symbol: 'none',
                sampling: 'average',
                data: resumeCountData
            });
            firstChartLegend.push("新增简历数");
        }
        if (inArray(2,selectedOptionList)){
            countSeries.push({
                name:'推荐数',
                type:'line',
                smooth:true,
                symbol: 'none',
                sampling: 'average',
                data: entrustCountData
            });
            firstChartLegend.push("推荐数");
        }
        if (inArray(3,selectedOptionList)){
            countSeries.push({
                name:'面试数',
                type:'line',
                smooth:true,
                symbol: 'none',
                sampling: 'average',
                data: interviewCountData
            });
            firstChartLegend.push("面试数");
        }
        if (inArray(4,selectedOptionList)){
            countSeries.push({
                name:'offer数',
                type:'line',
                smooth:true,
                symbol: 'none',
                sampling: 'average',
                data: offerCountData
            });
            firstChartLegend.push("offer数");
        }
        if (inArray(5,selectedOptionList)){
            countSeries.push({
                name:'入职数',
                type:'line',
                smooth:true,
                symbol: 'none',
                sampling: 'average',
                data: jobCountData
            });
            firstChartLegend.push("入职数");
        }


        return countSeries;
        /*
        return [
                        {
                            name:'新增职位数',
                            type:'line',
                            smooth:true,
                            symbol: 'none',
                            sampling: 'average',
                            itemStyle: {
                                normal: {
                                    color: 'rgb(255, 70, 131)'
                                }
                            },
                            areaStyle: {
                                normal: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                        offset: 0,
                                        color: 'rgb(255, 158, 68)'
                                    }, {
                                        offset: 1,
                                        color: 'rgb(255, 70, 131)'
                                    }])
                                }
                            },
                            data: positionCountData
                        },
                        {
                            name:'新增简历数',
                            type:'line',
                            smooth:true,
                            symbol: 'none',
                            sampling: 'average',
                            itemStyle: {
                                normal: {
                                    color: 'rgb(55, 147, 219)'
                                }
                            },
                            areaStyle: {
                                normal: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                        offset: 0,
                                        color: 'rgb(55, 55, 55)'
                                    }, {
                                        offset: 1,
                                        color: 'rgb(55, 147, 219)'
                                    }])
                                }
                            },
                            data: resumeCountData
                        }
                    ];
                    */
    }

    function makeChart(){
        var startTime = $("#startTime").val();
        var unix_start = datetime_to_unix(startTime);
        var endTime = $("#endTime").val();
        var unix_end = datetime_to_unix(endTime);
        var company = $("#select").val();
        var info = {

        };
        info.company = $("#select").val();
        //info.company = '';
        info.startTime = unix_start;
        info.endTime = unix_end;
        info.reverseSelection = ($("#reverseSelection").attr("checked")=="checked")?"true":"";
        $.ajax({
            type: 'GET',
            url: "http://youpinsh.cn/index.php/home/user/stats",
            data: info,
            success: function (d, x, r){
                var dom = document.getElementById("charts");
                var myChart = echarts.init(dom);
                var app = {};
                var option = null;
                var date = [];

                

                /*
                var resume = d.info.resume;
                for (var i = 1; i < resume.length; i++) {
                    var x = resume[i];
                    date.push(timestampToDate(x.day));
                    data.push(x.count);
                }  
                */
                positionCountData = [];
                resumeCountData = [];
                interviewCountData = [];
                offerCountData = [];
                jobCountData = [];
                entrustCountData = [];

                var dataList = d.info;
                for (var i = 1; i < dataList.length; i++) {
                    var x = dataList[i];
                    date.push(timestampToDate(x.date));
                    positionCountData.push(x.positioncount);
                    resumeCountData.push(x.resumecount);
                    interviewCountData.push(x.interviewcount);
                    offerCountData.push(x.offercount);
                    jobCountData.push(x.jobcount);
                    entrustCountData.push(x.entrustcount);
                }  


                option = {
                    tooltip: {
                        trigger: 'axis'
                    },
                    title: {
                        left: 'center',
                        text: '',
                    },
                    legend: {
                        data:firstChartLegend
                    },
                    toolbox: {
                        show: true,
                        feature: {
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: date
                    },
                    yAxis: {
                        type: 'value',
                        boundaryGap: [0, '100%']
                    },
                    series: getCountSeries()
                };

                if (option && typeof option === "object") {
                    var startTime = +new Date();
                    myChart.setOption(option, true);
                    var endTime = +new Date();
                    var updateTime = endTime - startTime;
                }
            },
            error: function (){
            //  alert("提交成功");
            },
            //contentType: "application/json",
            dataType: "json"
        });
        $.ajax({
            type: 'GET',
            url: "http://youpinsh.cn/index.php/home/user/rates",
            data: info,
            success: function (d, x, r){
                var dom = document.getElementById("charts2");
                var myChart = echarts.init(dom);
                var app = {};
                var option = null;
                var date = [];

                
                /*
                var resume = d.info.resume;
                for (var i = 1; i < resume.length; i++) {
                    var x = resume[i];
                    date.push(timestampToDate(x.day));
                    data.push(x.count);
                }  
                */
                entrustRateData = [];
                interviewRateData = [];
                offerRateData = [];
                stayRateData = [];
                companyStayRateData = [];
                companyStayNumData = [];
                stayNumData = [];

                var dataList = d.info;
                for (var i = 1; i < dataList.length; i++) {
                    var x = dataList[i];
                    date.push(timestampToDate(x.date));
                    entrustRateData.push(x.entrust_rates);
                    interviewRateData.push(x.interview_rates);
                    offerRateData.push(x.offer_rates);
                    stayRateData.push(x.stayRate);
                    companyStayRateData.push(x.companyStayRate);
                    companyStayNumData.push(x.companyStayNum);
                    stayNumData.push(x.stayNum);
                }  

                option = {
                    tooltip: {
                        trigger: 'axis'
                    },
                    title: {
                        left: 'center',
                        text: '图2',
                    },
                    legend: {
                        data:['意向']
                    },
                    toolbox: {
                        show: true,
                        feature: {
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: date
                    },
                    yAxis: {
                        type: 'value',
                        boundaryGap: [0, '100%']
                    },
                    series: getCountSeries()
                };

                if (option && typeof option === "object") {
                    var startTime = +new Date();
                    myChart.setOption(option, true);
                    var endTime = +new Date();
                    var updateTime = endTime - startTime;
                }
            },
            error: function (){
            //  alert("提交成功");
            },
            //contentType: "application/json",
            dataType: "json"
        });
    }


       </script>
</html>